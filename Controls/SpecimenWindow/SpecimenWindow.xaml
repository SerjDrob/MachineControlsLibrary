<UserControl
    x:Class="MachineControlsLibrary.Controls.SpecimenWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:MachineControlsLibrary.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:local="clr-namespace:MachineControlsLibrary.Controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid
        x:Name="SpecWin"
        MouseLeftButtonDown="SpecWin_MouseLeftButtonDown"
        MouseLeftButtonUp="SpecWin_MouseLeftButtonUp"
        MouseMove="SpecWin_MouseMove">

        <Grid.Resources>
            <converters:GetTransformMatrixConverter2 x:Key="GetMatrix2" />
            <converters:ShapeScalingConverter x:Key="ShapeScalingConverter" />
            <converters:TestConverter x:Key="TestConverter" />
            <converters:BoolToVisibleConvereter x:Key="BoolToVisibleConvereter" />
            <converters:DivideConverter x:Key="DivideConverter" />
            <converters:XYToPointConverter x:Key="XYToPointConverter" />
            <local:FillPathConverter x:Key="FillPathConverter" />
            <local:BoolToOpacityInverseConverter x:Key="BoolToOpacityConverter" />
            <local:OnLayGeomMouseDownArgsConverter x:Key="MouseDownArgsConverter" />
            <Storyboard x:Key="BlinkingPointer">
                <ObjectAnimationUsingKeyFrames
                    AutoReverse="True"
                    RepeatBehavior="Forever"
                    Storyboard.TargetName="Pointer"
                    Storyboard.TargetProperty="Visibility"
                    Duration="0:0:1">
                    <ObjectAnimationUsingKeyFrames.KeyFrames>
                        <DiscreteObjectKeyFrame KeyTime="0:0:0.8" Value="{x:Static Visibility.Visible}" />
                    </ObjectAnimationUsingKeyFrames.KeyFrames>
                </ObjectAnimationUsingKeyFrames>
            </Storyboard>
            <MatrixTransform x:Key="MTrans">
                <MatrixTransform.Matrix>
                    <MultiBinding Converter="{StaticResource GetMatrix2}">
                        <Binding ElementName="SpecWin" Path="ActualWidth" />
                        <Binding ElementName="SpecWin" Path="ActualHeight" />
                        <Binding Path="DataContext.FieldSizeX" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.FieldSizeY" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.SpecMargin" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.XProportion" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.YProportion" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.AutoProportion" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.SpecSizeX" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext.SpecSizeY" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                        <Binding Path="DataContext" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                    </MultiBinding>
                </MatrixTransform.Matrix>
            </MatrixTransform>
            <i:ConditionalExpression x:Key="IsLightLayer">
                <i:ComparisonCondition
                    LeftOperand="{Binding Path=DataContext.LightPathModeOn, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Grid}}"
                    Operator="Equal"
                    RightOperand="True" />
            </i:ConditionalExpression>
        </Grid.Resources>
        <i:Interaction.Triggers>
            <i:DataTrigger Binding="{Binding PointerVisibility}" Value="True">
                <i:ControlStoryboardAction Storyboard="{StaticResource BlinkingPointer}" />
            </i:DataTrigger>
            <i:DataTrigger Binding="{Binding CutCursor}" Value="True">
                <i:ChangePropertyAction PropertyName="Cursor" Value="Cross" />
            </i:DataTrigger>
            <i:DataTrigger Binding="{Binding CutCursor}" Value="False">
                <i:ChangePropertyAction PropertyName="Cursor" Value="Arrow" />
            </i:DataTrigger>
        </i:Interaction.Triggers>
        <Grid
            x:Name="fieldGrid"
            Width="{Binding FieldSizeX}"
            Height="{Binding FieldSizeY}"
            LayoutTransform="{StaticResource MTrans}" />

        <Canvas
            x:Name="MainCanvas"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            Background="Transparent"
            RenderTransformOrigin="0.5 0.5">

            <ItemsControl
                x:Name="DxfItems"
                ItemsSource="{Binding LayGeoms, Mode=OneWay}"
                Visibility="{Binding IsVisible, Converter={StaticResource BoolToVisibleConvereter}}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Canvas>
                            <Path
                                Opacity="{Binding Path=DataContext.LightPathModeOn, Converter={StaticResource BoolToOpacityConverter}, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Grid}}"
                                Stroke="{Binding Path=LayerColor}"
                                StrokeThickness="{Binding StrokeThickness}"
                                Visibility="{Binding Path=LayerEnable, Converter={StaticResource BoolToVisibleConvereter}}">
                                <Path.Fill>
                                    <MultiBinding Converter="{StaticResource FillPathConverter}">
                                        <Binding Path="LayerColor" />
                                        <Binding ElementName="SpecWin" Path="DataContext.IsFillPath" />
                                    </MultiBinding>
                                </Path.Fill>
                                <Path.Data>
                                    <GeometryGroup Children="{Binding Geometries}" Transform="{StaticResource MTrans}" />
                                </Path.Data>
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="MouseEnter">
                                        <i:Interaction.Behaviors>
                                            <i:ConditionBehavior Condition="{StaticResource IsLightLayer}" />
                                        </i:Interaction.Behaviors>
                                        <i:ChangePropertyAction PropertyName="Opacity" Value="1" />
                                    </i:EventTrigger>
                                    <i:EventTrigger EventName="MouseLeave">
                                        <i:Interaction.Behaviors>
                                            <i:ConditionBehavior Condition="{StaticResource IsLightLayer}" />
                                        </i:Interaction.Behaviors>
                                        <i:ChangePropertyAction PropertyName="Opacity" Value="0" />
                                    </i:EventTrigger>
                                    <i:EventTrigger EventName="MouseDown">
                                        <i:InvokeCommandAction
                                            Command="{Binding Path=DataContext.OnLayGeomClickedCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Grid}}"
                                            EventArgsConverter="{StaticResource MouseDownArgsConverter}"
                                            EventArgsConverterParameter="{StaticResource MTrans}"
                                            PassEventArgsToCommand="True" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </Path>
                        </Canvas>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            <Canvas.RenderTransform>
                <TransformGroup x:Name="MyTransform">
                    <ScaleTransform ScaleX="{Binding MirrorX}" ScaleY="1" />
                    <RotateTransform Angle="{Binding Angle}" />
                    <ScaleTransform ScaleX="1" ScaleY="-1" />
                    <TranslateTransform X="{Binding OffsetX}" Y="{Binding OffsetY}" />
                </TransformGroup>
            </Canvas.RenderTransform>
        </Canvas>
        <Canvas RenderTransformOrigin="0.5 0.5">
            <Path
                x:Name="Pointer"
                Stroke="Yellow"
                StrokeThickness="{Binding PointerThickness}"
                Visibility="Hidden">
                <Path.Data>
                    <EllipseGeometry RadiusX="{Binding PointerDiameter, Converter={StaticResource DivideConverter}, ConverterParameter=2}" RadiusY="{Binding PointerDiameter, Converter={StaticResource DivideConverter}, ConverterParameter=2}">
                        <EllipseGeometry.Center>
                            <MultiBinding Converter="{StaticResource XYToPointConverter}">
                                <Binding Path="DataContext.PointerX" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                <Binding Path="DataContext.PointerY" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                            </MultiBinding>
                        </EllipseGeometry.Center>
                        <EllipseGeometry.Transform>
                            <MatrixTransform>
                                <MatrixTransform.Matrix>
                                    <MultiBinding Converter="{StaticResource GetMatrix2}">
                                        <Binding ElementName="SpecWin" Path="ActualWidth" />
                                        <Binding ElementName="SpecWin" Path="ActualHeight" />
                                        <Binding Path="DataContext.FieldSizeX" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.FieldSizeY" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.SpecMargin" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.XProportion" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.YProportion" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.AutoProportion" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.SpecSizeX" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext.SpecSizeY" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                        <Binding Path="DataContext" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=Grid}" />
                                    </MultiBinding>
                                </MatrixTransform.Matrix>
                            </MatrixTransform>
                        </EllipseGeometry.Transform>
                    </EllipseGeometry>
                </Path.Data>
            </Path>
            <Canvas.RenderTransform>
                <TransformGroup>
                    <RotateTransform Angle="{Binding Angle}" />
                    <ScaleTransform ScaleX="{Binding MirrorX}" ScaleY="-1" />
                    <TranslateTransform X="{Binding OffsetX}" Y="{Binding OffsetY}" />
                </TransformGroup>
            </Canvas.RenderTransform>
        </Canvas>
        <Canvas>
            <Rectangle
                Canvas.Left="{Binding SelectionBoxX}"
                Canvas.Top="{Binding SelectionBoxY}"
                Width="{Binding SelectionBoxWidth}"
                Height="{Binding SelectionBoxHeight}"
                Fill="AliceBlue"
                Opacity="0.5"
                RenderTransform="{Binding SelectionBoxScaleTransform}"
                Stroke="Red"
                StrokeDashArray="10 10"
                StrokeThickness="2"
                Visibility="{Binding IsSelectionBoxVisible, Converter={StaticResource Boolean2VisibilityConverter}}" />
        </Canvas>
        <hc:LoadingCircle Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}" />
    </Grid>
</UserControl>
